local Concord = require("modules.concord.concord")

local Intro = {}

local speed = {
	building = 32 * 2,
	road = 128 * 2,
	post = 128 * 2,
	grass1 = 160 * 2,
	grass2 = 164 * 2,
	bg_tree = -100 * 2,
	fg_tree = -168 * 2,
}

local z_index = {
	building = 1,
	road = 2,
	bg_tree = 3,
	post = 4,
	grass1 = 5,
	car = 6,
	fg_tree = 7,
	grass2 = 8,
}

!if not _RELEASE then
last_id = 0
!end

function Intro.parallax(e, sprite, quad_width, tag)
	!if _ASSERT then
	Assert.should_exists(speed[tag])
	Assert.should_exists(z_index[tag])
	!end
	local w, h = sprite:getDimensions()
	local quad = love.graphics.newQuad(0, 0, quad_width, h, w, h)
	e:give("sprite", sprite)
	:give("quad", quad)
	:give("position", vec2:new(0, 0))
	:give("parallax", vec2:new(speed[tag], 0))
	:give("z_index", z_index[tag])
end

function Intro.bg_tree_data(e, images, max_width)
	e:give("tree_data", {
		images = images,
		max_width = max_width,
		parallax = vec2:new(speed.bg_tree, 0),
		offset_y = -16,
		z_index = z_index.bg_tree,
	})
end

function Intro.fg_tree_data(e, images, max_width)
	e:give("tree_data", {
		images = images,
		max_width = max_width,
		parallax = vec2:new(speed.fg_tree, 0),
		z_index = z_index.fg_tree,
		ensure = 2,
	})
end

function Intro.tree(e, img, pos, index, parallax, z_index)
	e:give("sprite", img)
	:give("position", pos)
	:give("tree", index)
	:give("parallax", parallax)
	:give("z_index", z_index)

	!if not _RELEASE then
	e:give("debug_slab", "tree_" .. last_id)
	last_id = last_id + 1
	!end
end

function Intro.car(e, spritesheet)
	local data = {
		spritesheet = spritesheet,
		frames = { "1-3", 1, "1-3", 2, "1-3", 3, "1-3", 4 },
		delay = 0.2,
		rows_count = 4,
		columns_count = 3,
		n_frames = 12
	}
	local car_init_pos = vec2:new(-64, 325)
	e:give("animation_data", data)
	:give("position", car_init_pos)
	:give("animation", false)
	:give("z_index", z_index.car)
end

function Intro.car_reflect(e, spritesheet, car)
	local data = {
		spritesheet = spritesheet,
		frames = { "1-3", 1, "1-3", 2, "1-3", 3, "1-3", 4 },
		delay = 0.1,
		rows_count = 4,
		columns_count = 3,
		n_frames = 12
	}
	e:give("animation_data", data)
	:give("position", car:get("position").pos:copy())
	:give("animation", false)
	:give("attach_to", car)
	:give("hidden")
	:give("z_index", z_index.car)
end

return Intro
